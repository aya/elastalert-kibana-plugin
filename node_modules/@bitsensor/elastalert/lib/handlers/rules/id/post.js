'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = rulePostHandler;

var _route_logger = require('src/routes/route_logger');

var _route_logger2 = _interopRequireDefault(_route_logger);

var _utils = require('src/common/errors/utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var logger = new _route_logger2.default('/rules/:id', 'POST');

function rulePostHandler(request, result) {
  /**
   * @type {ElastalertServer}
   */
  console.log('body', request.body);
  var server = request.app.get('server');
  var body = request.body ? request.body.yaml : undefined;

  console.log('body', request.body);

  server.rulesController.rule(request.params.id).then(function (rule) {
    rule.edit(body).then(function () {
      result.send({
        created: true,
        id: request.params.id
      });
      logger.sendSuccessful();
    }).catch(function (error) {
      (0, _utils.sendRequestError)(result, error);
      logger.sendFailed(error);
    });
  }).catch(function (error) {
    if (error.type === 'ruleNotFound') {
      server.rulesController.createRule(request.params.id, body).then(function () {
        logger.sendSuccessful();
        result.send({
          created: true,
          id: request.params.id
        });
      }).catch(function (error) {
        logger.sendFailed(error);
        (0, _utils.sendRequestError)(result, error);
      });
    } else {
      logger.sendFailed(error);
      (0, _utils.sendRequestError)(result, error);
    }
  });
}